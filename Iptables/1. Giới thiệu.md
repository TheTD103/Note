# Một số tìm hiểu về iptables
**Iptables** là Firewall được cấu hình và hoạt động trên nền Console rất nhỏ và tiện dụng, **Iptables** do Netfilter Organiztion viết ra để tăng tính năng bảo mật trên hệ thống Linux. **Iptables** cung cấp các tính năng sau:
- **Tích hợp tốt với kernel của Linux**  
- **Có khả năng phân tích package hiệu quả:** `iptables` có thể kiểm tra và phân tích các gói tin dựa trên nhiều tiêu chí khác nhau như địa chỉ IP nguồn và đích, cổng nguồn và đích, giao thức sử dụng, và nhiều yếu tố khác. 
- **Lọc package dựa vào MAC và một số cờ hiệu trong TCP Header:** 
    - `iptables` có khả năng lọc gói tin dựa trên địa chỉ MAC, điều này rất hữu ích trong mạng LAN để kiểm soát các thiết bị cụ thể.
    - `iptables` cũng có thể lọc dựa trên các cờ trong TCP header như SYN, ACK, FIN, RST, giúp quản trị viên có thể kiểm soát các kết nối TCP một cách chi tiết.
- Cung cấp chi tiết các tùy chọn để ghi nhận sự kiện hệ thống. 
- Cung cấp kỹ thuật NAT. 
- Có khả năng ngăn chặn một số cơ chế tấn công theo kiểu DoS.
## 1. Các khái niệm
### 1.1. Tables (Bảng)
`iptables` có một số bảng, mỗi bảng chứa các chuỗi (chains) được sử dụng để xử lý các loại gói tin khác nhau

<div style="text-align: center;">
    <img src="https://i.imgur.com/zr5K2kB.jpg">
</div>

- **Filter:** Lọc gói dữi liệu
    - Quá trình bắt gói tin: Khi gói tin đến máy chủ, iptables sẽ kiểm tra các quy tắc trong chuỗi `INPUT`. Nếu gói tin phù hợp với một **chain**, hành động tương tứng sẽ được thực hiện.
    - Gồm 3 **chain**:
        - FORWARD CHAIN: lọc gói khi đi đến các server khác
        - Input chain: Lọc gói khi đi vào trong server
        - Output chain: Lọc gói khi ra khỏi server
    - Ví dụ:
    ```sh
        iptables -A INPUT -s 192.168.1.0/24 -j ACCEPT  # Cho phép tất cả các kết nối từ mạng 192.168.1.0/24
        iptables -A INPUT -p tcp --dport 80 -j ACCEPT   # Cho phép các kết nối đến cổng 80 (HTTP)
        iptables -A INPUT -j DROP                       # Từ chối tất cả các kết nối khác
    ```
- **NAT (Network address translation):** Là quá trình chuyển đổi các port nguồn, đích, địa chỉ đích của một gói tin. Cho phép:
    - **Ẩn các địa chỉ IP Private:** Dùng NAT để ánh xạ nhiều IP private trong mạng LAN thành một địa chỉ IP public -> Tiêt kiệm địa chỉ IP và tăng cường bảo mật vì các thiết bị trong mạng LAN không bị lộ trực tiếp ra ngoài internet
    - **Chuyển tiếp cổng:** Cho phép chuyển tiếp các cổng từ địa chỉ ip public đến các địa chỉ ip private
    - **Cân bằng tải:** Sử dụng NAT để phân phối lưu lượng truy cập đến nhiều máy chủ

    **Trong iptables**, NAT có 2 chains chính:
    -  **PREROUTING:** thay đổi địa chỉ đến của gói dữ liệu khi cần thiết.

    - **POSTROUTING:** thay đổi địa chỉ nguồn của gói dữ liệu khi cần thiết.

- **Mangle:** chịu trách nhiệm thay đổi các bits chất lượng dịch vụ trong TCP header như TOS (type of service), TTL (Time to live), và MARK

- **Raw**: 

**Bảng 1: Các loại Queues và Chain cùng chức năng của chúng**

|**Loại queues**|**Chức năng queues**|**Quy tắc xử lý gói (Chain)**|**Chức năng của Chain**|
|---------------|--------------------|-----------------------------|-----------------------|
|**Filter**|Lọc gói|FORWARD|Lọc gói dữ liệu đi đến các server khác kết nối trên các NIC khác của firewall|
|||INPUT| Lọc gói đi đến Firewall|
|||OUTPUT| Lọc gói đi ra khỏi firewall|
|**NAT**||PREROUTING|Việc thay đổi địa chỉ diễn ra trước khi định tuyến. Thay đổi địa chỉ đích sẽ giúp gói dữ liệu phù hợp với bảng định tuyến của firewall. Sử dụng Destination NAT (DNAT) 
|||POSTROUTING|Việc thay đổi địa chỉ diễn ra sau khi định tuyến. Sử dụng Source NAT (SNAT)
|||OUTPUT| NAT sử dụng cho các gói dữ liệu xuất phát từ firewall. Hiếm khi dùng trong môi trường SOHO (Small office - home office)
|**Mangle**|Chỉnh sửa TCP header|PREROUTING| Điều chỉnh các bit quy định chất lượng dịch vụ trước khi định tuyến. Hiếm khi dùng trong môi trường SOHO
|||POSTROUTING|Điều chỉnh các bit quy định chất lượng dịch vụ trước khi định tuyến. Hiếm khi dùng trong môi trường SOHO
|||OUTPUT|Điều chỉnh các bit quy định chất lượng dịch vụ trước khi định tuyến. Hiếm khi dùng trong môi trường SOHO
|||INPUT|Điều chỉnh các bit quy định chất lượng dịch vụ trước khi định tuyến. Hiếm khi dùng trong môi trường SOHO
|||FORWARD|Điều chỉnh các bit quy định chất lượng dịch vụ trước khi định tuyến. Hiếm khi dùng trong môi trường SOHO